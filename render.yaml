# Render Blueprint for Unified Single Service Deployment
# Frontend + Backend served from one web service

services:
  # Unified Web Service - Serves both frontend and backend
  - type: web
    name: personal-knowledge-base
    runtime: node
    region: oregon  # Choose your preferred region
    plan: starter  # Upgrade to standard for better performance
    buildCommand: NODE_OPTIONS="--max-old-space-size=4096" npm run install:all && npm run build
    startCommand: npm start
    healthCheckPath: /api/health
    autoDeploy: true
    
    envVars:
      - key: NODE_ENV
        value: production
      
      - key: PORT
        value: 3001
      
      # Database
      - key: MONGODB_URI
        sync: false  # Set manually in Render dashboard
      
      # AI API Keys
      - key: OPENAI_API_KEY
        sync: false
      
      - key: COHERE_API_KEY
        sync: false  # Optional: for better reranking
      
      # Redis Cache (optional but recommended)
      - key: REDIS_ENABLED
        value: "true"
      
      - key: REDIS_URL
        fromService:
          type: redis
          name: knowledge-base-redis
          property: connectionString
      
      # CORS - not needed since frontend and backend are same origin
      - key: CORS_ORIGINS
        value: "*"
      
      # Logging
      - key: LOG_LEVEL
        value: info
      
      # Performance
      - key: CACHE_WARMUP_ON_START
        value: "true"
      
      - key: NODE_OPTIONS
        value: "--max-old-space-size=512"
    
    # Persistent disk for uploads
    disk:
      name: uploads
      mountPath: /opt/render/project/src/backend/uploads
      sizeGB: 1

  # Redis Cache - Optional but highly recommended for performance
  - type: redis
    name: knowledge-base-redis
    plan: starter  # 25MB free tier
    ipAllowList: []  # Only allow internal connections
